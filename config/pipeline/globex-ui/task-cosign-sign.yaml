apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cosign-sign
spec:
  params:
  - default: docker.io/sonarsource/sonar-scanner-cli:latest
    name: image
    type: string
  - default: secret/data/cosign
    name: vaultSecretPath
    type: string
  - default: redhat-registry-secret
    name: registrySecret
    type: string
  results:
  - description: The signature of the image
    name: tlogIndex
  steps:
  - image: openshift/origin-cli
    name: get-vault-secret
    script: >
      set -x

      oc exec -it vault-0 -n vault -- vault kv get -field=cosign.key
      $(params.vaultSecretPath) > /workspace/cosign.key

      oc exec -it vault-0 -n vault -- vault kv get -field=cosign.password
      $(params.vaultSecretPath) > /workspace/cosign.password
  - env:
      - name: REGISTRY_SECRET
        valueFrom:
          secretKeyRef:
            key: .dockerconfigjson
            name: $(params.registrySecret)
    image: quay.io/redhat-gpte/cosign
    name: sign-image
    resources: {}
    script: >
      set -x

      echo "${REGISTRY_SECRET}" > /home/cosign/.docker/config.json

      COSIGN_EXPERIMENTAL=1 COSIGN_PASSWORD=$(cat /workspace/cosign.password)
      cosign sign --key /workspace/cosign.key --yes $(params.image)

      cosign download signature $(params.image) --output-file
      /workspace/signature.sig
  - image: stedolan/jq
    name: extract-tlog
    script: |
      set -x
      jq '.Bundle.Payload.logIndex' /workspace/signature.sig > $(results.tlogIndex.path)
  workspaces:
  - name: signature
